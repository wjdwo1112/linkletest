<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ggamakun.linkle.domain.club.repository.IClubRepository">

<!-- 회원이 가입한 동호회 목록 조회 -->
<select id="findClubsByMemberId"  resultType="com.ggamakun.linkle.domain.club.dto.ClubSummary">
SELECT 
	c.club_id AS clubId,
	c.name AS name,
	c.description AS description,
	cm.status AS status,
	cm.role AS role
FROM CLUB c
JOIN CLUB_MEMBER cm ON c.club_id = cm.club_id
WHERE cm.member_id = #{memberId}
	AND c.is_deleted = 'N'
	AND cm.is_deleted = 'N'
	AND cm.status = '승인'
ORDER BY cm.joined_at DESC
</select>

<!-- 특정 동호회의 회원인지 확인 -->
<select id="isClubMember" resultType="int">
SELECT COUNT(*)
FROM CLUB_MEMBER
WHERE club_id = #{clubId}
AND member_id = #{memberId}
AND status = '승인'
AND is_deleted = 'N'


</select>

<!-- 특정 동호회에서 회원의 역할 조회 -->
<select id="getMemberRole" resultType="string">
SELECT role
FROM CLUB_MEMBER
WHERE club_id = #{clubId}
AND member_id = #{memberId}
AND status='승인'
AND is_deleted='N'

</select>

	<!-- 동호회 생성 -->
    <insert id="insertClub" parameterType="com.ggamakun.linkle.domain.club.dto.CreateClubRequestDto">
        <selectKey keyProperty="clubId" resultType="int" order="BEFORE">
            SELECT SEQ_CLUB.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO CLUB (
            club_id,
            file_id,
            name,
            leader_id,
            description,
            opened_at,
            created_by,
            created_at,
            region,
            max_members,
            category_id,
            is_deleted
        ) VALUES (
            #{clubId},
            #{fileId},
            #{name},
            #{createdBy},
            #{description},
            SYSDATE,
            #{createdBy},
            SYSDATE,
            #{sido} || ' ' || #{sigungu},
            #{maxMembers},
            #{categoryId},
            'N'
        )
    </insert>

    <!-- 동호회 회원 추가 -->
    <insert id="insertClubMember">
        INSERT INTO CLUB_MEMBER (
            club_id,
            member_id,
            role,
            created_by,
            created_at,
            status,
            joined_at,
            is_deleted
        ) VALUES (
            #{clubId},
            #{memberId},
            '리더',
            #{memberId},
            SYSDATE,
            '승인',
            SYSDATE,
            'N'
        )
    </insert>

    <!-- 동호회 조회 -->
    <select id="findById" parameterType="int" resultType="com.ggamakun.linkle.domain.club.entity.Club">
        SELECT 
            club_id as clubId,
            file_id as fileId,
            name,
            leader_id as leaderId,
            description,
            opened_at as openedAt,
            closed_at as closedAt,
            created_by as createdBy,
            created_at as createdAt,
            updated_by as updatedBy,
            updated_at as updatedAt,
            region,
            max_members as maxMembers,
            category_id as categoryId,
            is_deleted as isDeleted
        FROM CLUB
        WHERE club_id = #{clubId}
          AND is_deleted = 'N'
    </select>


</mapper>