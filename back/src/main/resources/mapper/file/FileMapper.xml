<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ggamakun.linkle.domain.file.repository.IFileStorageRepository">

    <!-- 파일 정보 저장 -->
    <insert id="insertFile" parameterType="com.ggamakun.linkle.domain.file.entity.FileStorage">
        INSERT INTO FILE_STORAGE
            (FILE_ID, ORIGINAL_FILE_NAME, FILE_LINK, FILE_SIZE, FILE_TYPE, 
             UPLOADER_ID, FILE_HASH, CREATED_BY, CREATED_AT, IS_DELETED)
        VALUES
            (SEQ_FILE_STORAGE.NEXTVAL, #{originalFileName}, #{fileLink}, #{fileSize}, #{fileType},
             #{uploaderId}, #{fileHash}, #{createdBy}, SYSDATE, 'N')
    </insert>

    <!-- 파일 ID로 조회 -->
    <select id="findById" resultType="com.ggamakun.linkle.domain.file.entity.FileStorage">
        SELECT
            FILE_ID AS fileId,
            ORIGINAL_FILE_NAME AS originalFileName,
            FILE_LINK AS fileLink,
            FILE_SIZE AS fileSize,
            FILE_TYPE AS fileType,
            UPLOADER_ID AS uploaderId,
            FILE_HASH AS fileHash,
            CREATED_BY AS createdBy,
            CREATED_AT AS createdAt,
            UPDATED_BY AS updatedBy,
            UPDATED_AT AS updatedAt,
            IS_DELETED AS isDeleted
        FROM FILE_STORAGE
        WHERE FILE_ID = #{fileId}
          AND IS_DELETED = 'N'
    </select>

    <!-- 파일 ID 목록으로 조회 -->
    <select id="findByIds" resultType="com.ggamakun.linkle.domain.file.entity.FileStorage">
        SELECT
            FILE_ID AS fileId,
            ORIGINAL_FILE_NAME AS originalFileName,
            FILE_LINK AS fileLink,
            FILE_SIZE AS fileSize,
            FILE_TYPE AS fileType,
            UPLOADER_ID AS uploaderId,
            FILE_HASH AS fileHash,
            CREATED_BY AS createdBy,
            CREATED_AT AS createdAt,
            UPDATED_BY AS updatedBy,
            UPDATED_AT AS updatedAt,
            IS_DELETED AS isDeleted
        FROM FILE_STORAGE
        WHERE FILE_ID IN
        <foreach item="fileId" collection="fileIds" open="(" separator="," close=")">
            #{fileId}
        </foreach>
          AND IS_DELETED = 'N'
    </select>

    <!-- 파일 삭제 (소프트 삭제) -->
    <update id="deleteFile">
        UPDATE FILE_STORAGE
        SET IS_DELETED = 'Y',
            UPDATED_AT = SYSDATE
        WHERE FILE_ID = #{fileId}
          AND IS_DELETED = 'N'
    </update>

    <!-- 파일 해시로 조회 -->
    <select id="findByHash" resultType="com.ggamakun.linkle.domain.file.entity.FileStorage">
        SELECT
            FILE_ID AS fileId,
            ORIGINAL_FILE_NAME AS originalFileName,
            FILE_LINK AS fileLink,
            FILE_SIZE AS fileSize,
            FILE_TYPE AS fileType,
            UPLOADER_ID AS uploaderId,
            FILE_HASH AS fileHash,
            CREATED_BY AS createdBy,
            CREATED_AT AS createdAt,
            UPDATED_BY AS updatedBy,
            UPDATED_AT AS updatedAt,
            IS_DELETED AS isDeleted
        FROM FILE_STORAGE
        WHERE FILE_HASH = #{fileHash}
          AND IS_DELETED = 'N'
    </select>

</mapper>